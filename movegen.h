#ifndef MOVEGEN_H
#define MOVEGEN_H

#include "movelist.h"
#include "piece.h"
#include "types.h"

class Board;

class MoveGen
{

public:
    static uint64_t perft(Board &board, int depth, bool isRoot);
    static void generateMoves(Board &board, MoveList &list);
    static bool isPinned(const Board &board, uint8_t currPiece);

    // Square 0 = bottom-left, Square 63 = top-right
    static constexpr int directions[8] = {-1, 1, -8, 8, -7, 7, -9, 9};

    static constexpr int disToEdge[64][8] = {
        // -1, 1, -8, 8, -7, 7, -9, 9
        {0, 7, 0, 7, 0, 0, 0, 7}, // Square 0 (a1)
        {1, 6, 0, 7, 0, 1, 0, 6}, // Square 1 (b1)
        {2, 5, 0, 7, 0, 2, 0, 5}, // Square 2 (c1)
        {3, 4, 0, 7, 0, 3, 0, 4}, // Square 3 (d1)
        {4, 3, 0, 7, 0, 4, 0, 3}, // Square 4 (e1)
        {5, 2, 0, 7, 0, 5, 0, 2}, // Square 5 (f1)
        {6, 1, 0, 7, 0, 6, 0, 1}, // Square 6 (g1)
        {7, 0, 0, 7, 0, 7, 0, 0}, // Square 7 (h1)
        {0, 7, 1, 6, 1, 0, 0, 6}, // Square 8 (a2)
        {1, 6, 1, 6, 1, 1, 1, 6}, // Square 9 (b2)
        {2, 5, 1, 6, 1, 2, 1, 5}, // Square 10 (c2)
        {3, 4, 1, 6, 1, 3, 1, 4}, // Square 11 (d2)
        {4, 3, 1, 6, 1, 4, 1, 3}, // Square 12 (e2)
        {5, 2, 1, 6, 1, 5, 1, 2}, // Square 13 (f2)
        {6, 1, 1, 6, 1, 6, 1, 1}, // Square 14 (g2)
        {7, 0, 1, 6, 0, 6, 1, 0}, // Square 15 (h2)
        {0, 7, 2, 5, 2, 0, 0, 5}, // Square 16 (a3)
        {1, 6, 2, 5, 2, 1, 1, 5}, // Square 17 (b3)
        {2, 5, 2, 5, 2, 2, 2, 5}, // Square 18 (c3)
        {3, 4, 2, 5, 2, 3, 2, 4}, // Square 19 (d3)
        {4, 3, 2, 5, 2, 4, 2, 3}, // Square 20 (e3)
        {5, 2, 2, 5, 2, 5, 2, 2}, // Square 21 (f3)
        {6, 1, 2, 5, 1, 5, 2, 1}, // Square 22 (g3)
        {7, 0, 2, 5, 0, 5, 2, 0}, // Square 23 (h3)
        {0, 7, 3, 4, 3, 0, 0, 4}, // Square 24 (a4)
        {1, 6, 3, 4, 3, 1, 1, 4}, // Square 25 (b4)
        {2, 5, 3, 4, 3, 2, 2, 4}, // Square 26 (c4)
        {3, 4, 3, 4, 3, 3, 3, 4}, // Square 27 (d4)
        {4, 3, 3, 4, 3, 3, 3, 3}, // Square 28 (e4)
        {5, 2, 3, 4, 2, 3, 3, 2}, // Square 29 (f4)
        {6, 1, 3, 4, 1, 3, 3, 1}, // Square 30 (g4)
        {7, 0, 3, 4, 0, 3, 3, 0}, // Square 31 (h4)
        {0, 7, 4, 3, 4, 0, 0, 3}, // Square 32 (a5)
        {1, 6, 4, 3, 4, 1, 1, 3}, // Square 33 (b5)
        {2, 5, 4, 3, 4, 2, 2, 3}, // Square 34 (c5)
        {3, 4, 4, 3, 4, 3, 3, 3}, // Square 35 (d5)
        {4, 3, 4, 3, 3, 3, 4, 3}, // Square 36 (e5)
        {5, 2, 4, 3, 2, 4, 4, 2}, // Square 37 (f5)
        {6, 1, 4, 3, 1, 4, 4, 1}, // Square 38 (g5)
        {7, 0, 4, 3, 0, 4, 4, 0}, // Square 39 (h5)
        {0, 7, 5, 2, 5, 0, 0, 2}, // Square 40 (a6)
        {1, 6, 5, 2, 5, 1, 1, 2}, // Square 41 (b6)
        {2, 5, 5, 2, 5, 2, 2, 2}, // Square 42 (c6)
        {3, 4, 5, 2, 4, 3, 3, 2}, // Square 43 (d6)
        {4, 3, 5, 2, 3, 4, 4, 2}, // Square 44 (e6)
        {5, 2, 5, 2, 2, 5, 5, 2}, // Square 45 (f6)
        {6, 1, 5, 2, 1, 5, 5, 1}, // Square 46 (g6)
        {7, 0, 5, 2, 0, 5, 5, 0}, // Square 47 (h6)
        {0, 7, 6, 1, 6, 0, 0, 1}, // Square 48 (a7)
        {1, 6, 6, 1, 6, 1, 1, 1}, // Square 49 (b7)
        {2, 5, 6, 1, 5, 2, 2, 1}, // Square 50 (c7)
        {3, 4, 6, 1, 4, 3, 3, 1}, // Square 51 (d7)
        {4, 3, 6, 1, 3, 4, 4, 1}, // Square 52 (e7)
        {5, 2, 6, 1, 2, 5, 5, 1}, // Square 53 (f7)
        {6, 1, 6, 1, 1, 6, 6, 1}, // Square 54 (g7)
        {7, 0, 6, 1, 0, 6, 6, 0}, // Square 55 (h7)
        {0, 7, 7, 0, 7, 0, 0, 0}, // Square 56 (a8)
        {1, 6, 7, 0, 6, 0, 1, 0}, // Square 57 (b8)
        {2, 5, 7, 0, 5, 0, 2, 0}, // Square 58 (c8)
        {3, 4, 7, 0, 4, 0, 3, 0}, // Square 59 (d8)
        {4, 3, 7, 0, 3, 0, 4, 0}, // Square 60 (e8)
        {5, 2, 7, 0, 2, 0, 5, 0}, // Square 61 (f8)
        {6, 1, 7, 0, 1, 0, 6, 0}, // Square 62 (g8)
        {7, 0, 7, 0, 0, 0, 7, 0}  // Square 63 (h8)
    };

    static constexpr uint8_t knightMoves[64][8] = {
        {10, 17, 255, 255, 255, 255, 255, 255}, // Square 0 (a1)
        {11, 16, 18, 255, 255, 255, 255, 255},  // Square 1 (b1)
        {8, 12, 17, 19, 255, 255, 255, 255},    // Square 2 (c1)
        {9, 13, 18, 20, 255, 255, 255, 255},    // Square 3 (d1)
        {10, 14, 19, 21, 255, 255, 255, 255},   // Square 4 (e1)
        {11, 15, 20, 22, 255, 255, 255, 255},   // Square 5 (f1)
        {12, 21, 23, 255, 255, 255, 255, 255},  // Square 6 (g1)
        {13, 22, 255, 255, 255, 255, 255, 255}, // Square 7 (h1)
        {2, 18, 25, 255, 255, 255, 255, 255},   // Square 8 (a2)
        {3, 19, 24, 26, 255, 255, 255, 255},    // Square 9 (b2)
        {0, 4, 16, 20, 25, 27, 255, 255},       // Square 10 (c2)
        {1, 5, 17, 21, 26, 28, 255, 255},       // Square 11 (d2)
        {2, 6, 18, 22, 27, 29, 255, 255},       // Square 12 (e2)
        {3, 7, 19, 23, 28, 30, 255, 255},       // Square 13 (f2)
        {4, 20, 24, 29, 31, 255, 255, 255},     // Square 14 (g2)
        {5, 21, 30, 255, 255, 255, 255, 255},   // Square 15 (h2)
        {1, 10, 26, 33, 255, 255, 255, 255},    // Square 16 (a3)
        {0, 2, 11, 27, 32, 34, 255, 255},       // Square 17 (b3)
        {1, 3, 8, 12, 24, 28, 33, 35},          // Square 18 (c3)
        {2, 4, 9, 13, 25, 29, 34, 36},          // Square 19 (d3)
        {3, 5, 10, 14, 26, 30, 35, 37},         // Square 20 (e3)
        {4, 6, 11, 15, 27, 31, 36, 38},         // Square 21 (f3)
        {5, 7, 12, 28, 37, 39, 255, 255},       // Square 22 (g3)
        {6, 13, 29, 38, 255, 255, 255, 255},    // Square 23 (h3)
        {9, 18, 34, 41, 255, 255, 255, 255},    // Square 24 (a4)
        {8, 10, 19, 35, 40, 42, 255, 255},      // Square 25 (b4)
        {9, 11, 16, 20, 32, 36, 41, 43},        // Square 26 (c4)
        {10, 12, 17, 21, 33, 37, 42, 44},       // Square 27 (d4)
        {11, 13, 18, 22, 34, 38, 43, 45},       // Square 28 (e4)
        {12, 14, 19, 23, 35, 39, 44, 46},       // Square 29 (f4)
        {13, 15, 20, 36, 45, 47, 255, 255},     // Square 30 (g4)
        {14, 21, 37, 46, 255, 255, 255, 255},   // Square 31 (h4)
        {17, 26, 42, 49, 255, 255, 255, 255},   // Square 32 (a5)
        {16, 18, 27, 43, 48, 50, 255, 255},     // Square 33 (b5)
        {17, 19, 24, 28, 40, 44, 49, 51},       // Square 34 (c5)
        {18, 20, 25, 29, 41, 45, 50, 52},       // Square 35 (d5)
        {19, 21, 26, 30, 42, 46, 51, 53},       // Square 36 (e5)
        {20, 22, 27, 31, 43, 47, 52, 54},       // Square 37 (f5)
        {21, 23, 28, 44, 53, 55, 255, 255},     // Square 38 (g5)
        {22, 29, 45, 54, 255, 255, 255, 255},   // Square 39 (h5)
        {25, 34, 50, 57, 255, 255, 255, 255},   // Square 40 (a6)
        {24, 26, 35, 51, 56, 58, 255, 255},     // Square 41 (b6)
        {25, 27, 32, 36, 48, 52, 57, 59},       // Square 42 (c6)
        {26, 28, 33, 37, 49, 53, 58, 60},       // Square 43 (d6)
        {27, 29, 34, 38, 50, 54, 59, 61},       // Square 44 (e6)
        {28, 30, 35, 39, 51, 55, 60, 62},       // Square 45 (f6)
        {29, 31, 36, 52, 61, 63, 255, 255},     // Square 46 (g6)
        {30, 37, 53, 62, 255, 255, 255, 255},   // Square 47 (h6)
        {33, 42, 58, 255, 255, 255, 255, 255},  // Square 48 (a7)
        {32, 34, 43, 59, 255, 255, 255, 255},   // Square 49 (b7)
        {33, 35, 40, 44, 56, 60, 255, 255},     // Square 50 (c7)
        {34, 36, 41, 45, 57, 61, 255, 255},     // Square 51 (d7)
        {35, 37, 42, 46, 58, 62, 255, 255},     // Square 52 (e7)
        {36, 38, 43, 47, 59, 63, 255, 255},     // Square 53 (f7)
        {37, 39, 44, 60, 255, 255, 255, 255},   // Square 54 (g7)
        {38, 45, 61, 255, 255, 255, 255, 255},  // Square 55 (h7)
        {41, 50, 255, 255, 255, 255, 255, 255}, // Square 56 (a8)
        {40, 42, 51, 255, 255, 255, 255, 255},  // Square 57 (b8)
        {41, 43, 48, 52, 255, 255, 255, 255},   // Square 58 (c8)
        {42, 44, 49, 53, 255, 255, 255, 255},   // Square 59 (d8)
        {43, 45, 50, 54, 255, 255, 255, 255},   // Square 60 (e8)
        {44, 46, 51, 55, 255, 255, 255, 255},   // Square 61 (f8)
        {45, 47, 52, 255, 255, 255, 255, 255},  // Square 62 (g8)
        {46, 53, 255, 255, 255, 255, 255, 255}  // Square 63 (h8)
    };

    static constexpr uint8_t kingMoves[64][8] = {
        {1, 8, 9, 255, 255, 255, 255, 255},    // Square 0 (a1)
        {0, 2, 8, 9, 10, 255, 255, 255},       // Square 1 (b1)
        {1, 3, 9, 10, 11, 255, 255, 255},      // Square 2 (c1)
        {2, 4, 10, 11, 12, 255, 255, 255},     // Square 3 (d1)
        {3, 5, 11, 12, 13, 255, 255, 255},     // Square 4 (e1)
        {4, 6, 12, 13, 14, 255, 255, 255},     // Square 5 (f1)
        {5, 7, 13, 14, 15, 255, 255, 255},     // Square 6 (g1)
        {6, 14, 15, 255, 255, 255, 255, 255},  // Square 7 (h1)
        {0, 1, 9, 16, 17, 255, 255, 255},      // Square 8 (a2)
        {0, 1, 2, 8, 10, 16, 17, 18},          // Square 9 (b2)
        {1, 2, 3, 9, 11, 17, 18, 19},          // Square 10 (c2)
        {2, 3, 4, 10, 12, 18, 19, 20},         // Square 11 (d2)
        {3, 4, 5, 11, 13, 19, 20, 21},         // Square 12 (e2)
        {4, 5, 6, 12, 14, 20, 21, 22},         // Square 13 (f2)
        {5, 6, 7, 13, 15, 21, 22, 23},         // Square 14 (g2)
        {6, 7, 14, 22, 23, 255, 255, 255},     // Square 15 (h2)
        {8, 9, 17, 24, 25, 255, 255, 255},     // Square 16 (a3)
        {8, 9, 10, 16, 18, 24, 25, 26},        // Square 17 (b3)
        {9, 10, 11, 17, 19, 25, 26, 27},       // Square 18 (c3)
        {10, 11, 12, 18, 20, 26, 27, 28},      // Square 19 (d3)
        {11, 12, 13, 19, 21, 27, 28, 29},      // Square 20 (e3)
        {12, 13, 14, 20, 22, 28, 29, 30},      // Square 21 (f3)
        {13, 14, 15, 21, 23, 29, 30, 31},      // Square 22 (g3)
        {14, 15, 22, 30, 31, 255, 255, 255},   // Square 23 (h3)
        {16, 17, 25, 32, 33, 255, 255, 255},   // Square 24 (a4)
        {16, 17, 18, 24, 26, 32, 33, 34},      // Square 25 (b4)
        {17, 18, 19, 25, 27, 33, 34, 35},      // Square 26 (c4)
        {18, 19, 20, 26, 28, 34, 35, 36},      // Square 27 (d4)
        {19, 20, 21, 27, 29, 35, 36, 37},      // Square 28 (e4)
        {20, 21, 22, 28, 30, 36, 37, 38},      // Square 29 (f4)
        {21, 22, 23, 29, 31, 37, 38, 39},      // Square 30 (g4)
        {22, 23, 30, 38, 39, 255, 255, 255},   // Square 31 (h4)
        {24, 25, 33, 40, 41, 255, 255, 255},   // Square 32 (a5)
        {24, 25, 26, 32, 34, 40, 41, 42},      // Square 33 (b5)
        {25, 26, 27, 33, 35, 41, 42, 43},      // Square 34 (c5)
        {26, 27, 28, 34, 36, 42, 43, 44},      // Square 35 (d5)
        {27, 28, 29, 35, 37, 43, 44, 45},      // Square 36 (e5)
        {28, 29, 30, 36, 38, 44, 45, 46},      // Square 37 (f5)
        {29, 30, 31, 37, 39, 45, 46, 47},      // Square 38 (g5)
        {30, 31, 38, 46, 47, 255, 255, 255},   // Square 39 (h5)
        {32, 33, 41, 48, 49, 255, 255, 255},   // Square 40 (a6)
        {32, 33, 34, 40, 42, 48, 49, 50},      // Square 41 (b6)
        {33, 34, 35, 41, 43, 49, 50, 51},      // Square 42 (c6)
        {34, 35, 36, 42, 44, 50, 51, 52},      // Square 43 (d6)
        {35, 36, 37, 43, 45, 51, 52, 53},      // Square 44 (e6)
        {36, 37, 38, 44, 46, 52, 53, 54},      // Square 45 (f6)
        {37, 38, 39, 45, 47, 53, 54, 55},      // Square 46 (g6)
        {38, 39, 46, 54, 55, 255, 255, 255},   // Square 47 (h6)
        {40, 41, 49, 56, 57, 255, 255, 255},   // Square 48 (a7)
        {40, 41, 42, 48, 50, 56, 57, 58},      // Square 49 (b7)
        {41, 42, 43, 49, 51, 57, 58, 59},      // Square 50 (c7)
        {42, 43, 44, 50, 52, 58, 59, 60},      // Square 51 (d7)
        {43, 44, 45, 51, 53, 59, 60, 61},      // Square 52 (e7)
        {44, 45, 46, 52, 54, 60, 61, 62},      // Square 53 (f7)
        {45, 46, 47, 53, 55, 61, 62, 63},      // Square 54 (g7)
        {46, 47, 54, 62, 63, 255, 255, 255},   // Square 55 (h7)
        {48, 49, 57, 255, 255, 255, 255, 255}, // Square 56 (a8)
        {48, 49, 50, 56, 58, 255, 255, 255},   // Square 57 (b8)
        {49, 50, 51, 57, 59, 255, 255, 255},   // Square 58 (c8)
        {50, 51, 52, 58, 60, 255, 255, 255},   // Square 59 (d8)
        {51, 52, 53, 59, 61, 255, 255, 255},   // Square 60 (e8)
        {52, 53, 54, 60, 62, 255, 255, 255},   // Square 61 (f8)
        {53, 54, 55, 61, 63, 255, 255, 255},   // Square 62 (g8)
        {54, 55, 62, 255, 255, 255, 255, 255}  // Square 63 (h8)
    };

    static constexpr Bitboard whiteShortEmpty = 0x60ULL;
    static constexpr Bitboard whiteLongEmpty = 0x0EULL;
    static constexpr Bitboard blackShortEmpty = 0x6000000000000000ULL;
    static constexpr Bitboard blackLongEmpty = 0x0E00000000000000ULL;

private:
    static void pawnGen(Board &board, uint8_t startPos, Bitboard bitPos, MoveList &list);
    static void knightGen(Board &board, uint8_t startPos, MoveList &list);
    static void bishopGen(Board &board, uint8_t startPos, Bitboard bitPos, MoveList &list);
    static void rookGen(Board &board, uint8_t startPos, Bitboard bitPos, MoveList &list);
    static void kingGen(Board &board, uint8_t startPos, Bitboard bitPos, MoveList &list);
    static bool isAttacked(Board &board, uint8_t targetSquare);
    static bool tryMove(Board &board, Move testMove);
};

#endif