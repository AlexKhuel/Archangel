#ifndef MOVEGEN_H
#define MOVEGEN_H

#include "movelist.h"
#include "piece.h"
#include "types.h"

class Board;

class MoveGen
{

public:
    static uint64_t perft(Board &board, int depth, bool isRoot);
    static void generateMoves(Board &board, MoveList &list);
    static bool isPinned(const Board &board, uint8_t currPiece);

    // Directions: {-1,1,-8,8,-7,7,-9,9} = {S,N,W,E,SW,NE,NW,SE}
    // Square 0 = bottom-left, Square 63 = top-right
    static constexpr int directions[8] = {-1, 1, -8, 8, -7, 7, -9, 9};

    static constexpr uint8_t disToEdge[64][8] = {
        {0, 7, 0, 7, 0, 0, 0, 7}, {1, 6, 0, 7, 0, 1, 0, 6}, {2, 5, 0, 7, 0, 2, 0, 5}, {3, 4, 0, 7, 0, 3, 0, 4}, {4, 3, 0, 7, 0, 4, 0, 3}, {5, 2, 0, 7, 0, 5, 0, 2}, {6, 1, 0, 7, 0, 6, 0, 1}, {7, 0, 0, 7, 0, 7, 0, 0}, {0, 7, 1, 6, 1, 0, 0, 6}, {1, 6, 1, 6, 1, 1, 1, 6}, {2, 5, 1, 6, 1, 2, 1, 5}, {3, 4, 1, 6, 1, 3, 1, 4}, {4, 3, 1, 6, 1, 4, 1, 3}, {5, 2, 1, 6, 1, 5, 1, 2}, {6, 1, 1, 6, 1, 6, 1, 1}, {7, 0, 1, 6, 0, 6, 1, 0}, {0, 7, 2, 5, 2, 0, 0, 5}, {1, 6, 2, 5, 2, 1, 1, 5}, {2, 5, 2, 5, 2, 2, 2, 5}, {3, 4, 2, 5, 2, 3, 2, 4}, {4, 3, 2, 5, 2, 4, 2, 3}, {5, 2, 2, 5, 2, 5, 2, 2}, {6, 1, 2, 5, 1, 5, 2, 1}, {7, 0, 2, 5, 0, 5, 2, 0}, {0, 7, 3, 4, 3, 0, 0, 4}, {1, 6, 3, 4, 3, 1, 1, 4}, {2, 5, 3, 4, 3, 2, 2, 4}, {3, 4, 3, 4, 3, 3, 3, 4}, {4, 3, 3, 4, 3, 3, 3, 3}, {5, 2, 3, 4, 2, 3, 3, 2}, {6, 1, 3, 4, 1, 3, 3, 1}, {7, 0, 3, 4, 0, 3, 3, 0}, {0, 7, 4, 3, 3, 0, 0, 3}, {1, 6, 4, 3, 3, 1, 1, 3}, {2, 5, 4, 3, 3, 2, 2, 3}, {3, 4, 4, 3, 3, 3, 3, 3}, {4, 3, 4, 3, 3, 4, 4, 3}, {5, 2, 4, 3, 2, 4, 4, 2}, {6, 1, 4, 3, 1, 4, 4, 1}, {7, 0, 4, 3, 0, 4, 4, 0}, {0, 7, 5, 2, 2, 0, 0, 2}, {1, 6, 5, 2, 2, 1, 1, 2}, {2, 5, 5, 2, 2, 2, 2, 2}, {3, 4, 5, 2, 2, 3, 3, 2}, {4, 3, 5, 2, 2, 4, 4, 2}, {5, 2, 5, 2, 2, 5, 5, 2}, {6, 1, 5, 2, 1, 5, 5, 1}, {7, 0, 5, 2, 0, 5, 5, 0}, {0, 7, 6, 1, 1, 0, 0, 1}, {1, 6, 6, 1, 1, 1, 1, 1}, {2, 5, 6, 1, 1, 2, 2, 1}, {3, 4, 6, 1, 1, 3, 3, 1}, {4, 3, 6, 1, 1, 4, 4, 1}, {5, 2, 6, 1, 1, 5, 5, 1}, {6, 1, 6, 1, 1, 6, 6, 1}, {7, 0, 6, 1, 0, 6, 6, 0}, {0, 7, 7, 0, 0, 0, 0, 0}, {1, 6, 7, 0, 0, 1, 1, 0}, {2, 5, 7, 0, 0, 2, 2, 0}, {3, 4, 7, 0, 0, 3, 3, 0}, {4, 3, 7, 0, 0, 4, 4, 0}, {5, 2, 7, 0, 0, 5, 5, 0}, {6, 1, 7, 0, 0, 6, 6, 0}, {7, 0, 7, 0, 0, 7, 7, 0}};

    static constexpr uint8_t knightMoves[64][8] = {
        {10, 17, 255, 255, 255, 255, 255, 255}, // 0 (A1)
        {11, 16, 18, 255, 255, 255, 255, 255},  // 1 (B1)
        {8, 12, 17, 19, 255, 255, 255, 255},    // 2 (C1)
        {9, 13, 18, 20, 255, 255, 255, 255},    // 3 (D1)
        {10, 14, 19, 21, 255, 255, 255, 255},   // 4 (E1)
        {11, 15, 20, 22, 255, 255, 255, 255},   // 5 (F1)
        {12, 21, 23, 255, 255, 255, 255, 255},  // 6 (G1)
        {13, 22, 255, 255, 255, 255, 255, 255}, // 7 (H1)
        {18, 25, 2, 255, 255, 255, 255, 255},   // 8 (A2)
        {19, 24, 26, 3, 255, 255, 255, 255},    // 9 (B2)
        {0, 4, 16, 20, 25, 27, 255, 255},       // 10 (C2)
        {1, 5, 17, 21, 24, 26, 28, 255},        // 11 (D2)
        {2, 6, 18, 22, 25, 27, 29, 255},        // 12 (E2)
        {3, 7, 19, 23, 26, 28, 30, 255},        // 13 (F2)
        {4, 20, 29, 31, 255, 255, 255, 255},    // 14 (G2)
        {5, 21, 30, 255, 255, 255, 255, 255},   // 15 (H2)
        {1, 10, 26, 33, 255, 255, 255, 255},    // 16 (A3)
        {0, 2, 11, 27, 32, 34, 255, 255},       // 17 (B3)
        {1, 3, 8, 12, 24, 26, 28, 35},          // 18 (C3)
        {2, 4, 9, 13, 25, 27, 29, 34},          // 19 (D3)
        {3, 5, 10, 14, 26, 28, 30, 37},         // 20 (E3)
        {4, 6, 11, 15, 27, 29, 31, 38},         // 21 (F3)
        {5, 7, 12, 30, 31, 39, 255, 255},       // 22 (G3)
        {6, 13, 31, 38, 255, 255, 255, 255},    // 23 (H3)
        {9, 18, 34, 41, 255, 255, 255, 255},    // 24 (A4)
        {8, 10, 19, 35, 40, 42, 255, 255},      // 25 (B4)
        {9, 11, 16, 20, 33, 35, 37, 43},        // 26 (C4)
        {10, 12, 17, 21, 32, 34, 36, 44},       // 27 (D4)
        {11, 13, 18, 22, 35, 37, 39, 45},       // 28 (E4)
        {12, 14, 19, 23, 34, 36, 38, 46},       // 29 (F4)
        {13, 15, 20, 37, 39, 47, 255, 255},     // 30 (G4)
        {14, 21, 38, 46, 255, 255, 255, 255},   // 31 (H4)
        {17, 26, 42, 49, 255, 255, 255, 255},   // 32 (A5)
        {16, 18, 27, 43, 48, 50, 255, 255},     // 33 (B5)
        {17, 19, 24, 28, 41, 43, 45, 51},       // 34 (C5)
        {18, 20, 25, 29, 40, 42, 44, 50},       // 35 (D5)
        {19, 21, 26, 30, 43, 45, 47, 53},       // 36 (E5)
        {20, 22, 27, 31, 42, 44, 46, 52},       // 37 (F5)
        {21, 23, 28, 45, 47, 55, 255, 255},     // 38 (G5)
        {22, 29, 46, 54, 255, 255, 255, 255},   // 39 (H5)
        {25, 34, 50, 57, 255, 255, 255, 255},   // 40 (A6)
        {24, 26, 35, 51, 56, 58, 255, 255},     // 41 (B6)
        {25, 27, 32, 36, 49, 51, 53, 59},       // 42 (C6)
        {26, 28, 33, 37, 48, 50, 52, 58},       // 43 (D6)
        {27, 29, 34, 38, 51, 53, 55, 61},       // 44 (E6)
        {28, 30, 35, 39, 50, 52, 54, 60},       // 45 (F6)
        {29, 31, 36, 53, 55, 63, 255, 255},     // 46 (G6)
        {30, 37, 54, 62, 255, 255, 255, 255},   // 47 (H6)
        {33, 42, 58, 255, 255, 255, 255, 255},  // 48 (A7)
        {32, 34, 43, 59, 255, 255, 255, 255},   // 49 (B7)
        {33, 35, 40, 44, 57, 59, 61, 255},      // 50 (C7)
        {34, 36, 41, 45, 56, 58, 60, 255},      // 51 (D7)
        {35, 37, 42, 46, 59, 61, 63, 255},      // 52 (E7)
        {36, 38, 43, 47, 58, 60, 62, 255},      // 53 (F7)
        {37, 39, 44, 61, 63, 255, 255, 255},    // 54 (G7)
        {38, 45, 62, 255, 255, 255, 255, 255},  // 55 (H7)
        {41, 50, 255, 255, 255, 255, 255, 255}, // 56 (A8)
        {40, 42, 51, 255, 255, 255, 255, 255},  // 57 (B8)
        {41, 43, 48, 52, 255, 255, 255, 255},   // 58 (C8)
        {42, 44, 49, 53, 255, 255, 255, 255},   // 59 (D8)
        {43, 45, 50, 54, 255, 255, 255, 255},   // 60 (E8)
        {44, 46, 51, 55, 255, 255, 255, 255},   // 61 (F8)
        {45, 47, 52, 255, 255, 255, 255, 255},  // 62 (G8)
        {46, 53, 255, 255, 255, 255, 255, 255}  // 63 (H8)
    };

    static constexpr Bitboard whiteShortEmpty = 0x60ULL;
    static constexpr Bitboard whiteLongEmpty = 0x0EULL;
    static constexpr Bitboard blackShortEmpty = 0x6000000000000000ULL;
    static constexpr Bitboard blackLongEmpty = 0x0E00000000000000ULL;

private:
    static void pawnGen(Board &board, uint8_t startPos, Bitboard bitPos, MoveList &list);
    static void knightGen(Board &board, uint8_t startPos, MoveList &list);
    static void bishopGen(Board &board, uint8_t startPos, Bitboard bitPos, MoveList &list);
    static void rookGen(Board &board, uint8_t startPos, Bitboard bitPos, MoveList &list);
    static void kingGen(Board &board, uint8_t startPos, Bitboard bitPos, MoveList &list);
    static bool isAttacked(Board &board, uint8_t targetSquare);
    static bool tryMove(Board &board, Move testMove);
};

#endif